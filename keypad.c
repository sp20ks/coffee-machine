#include <avr/io.h>
#include <util/delay.h>
#include "keypad.h"
#include "lcd.h"

// Карта символов клавиатуры 4x4
char keypad_map[4][4] = {
    {'1', '2', '3', 'A'},
    {'4', '5', '6', 'B'},
    {'7', '8', '9', 'C'},
    {'*', '0', '#', 'D'}
};

// Инициализация порта для клавиатуры
void keypad_init() {
    DDRA = 0x0F;     // PA0-PA3 выходы (строки), PA4-PA7 входы (столбцы)
    PORTA = 0xF0;    // Включаем подтягивающие резисторы для столбцов
}

// Функция для считывания нажатой кнопки
char scan_keypad() {
    for (int row = 0; row < 4; row++) {
        // Устанавливаем низкий уровень на одной строке
        PORTA = ~(1 << row);
        _delay_ms(1);  // Небольшая задержка

        // Проверяем состояние каждого столбца
        for (int col = 0; col < 4; col++) {
            if (!(PINA & (1 << (col + 4)))) {  // Если на столбце низкий уровень
                return keypad_map[row][col];   // Возвращаем символ нажатой кнопки
            }
        }
    }
    return '\0';  // Нет нажатия
}
